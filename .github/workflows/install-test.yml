name: Installation Tests

on:
  push:
    branches: [main]
    paths:
      - 'scripts/**'
      - 'homebrew/**'
      - 'rust-mcp/debian/**'
      - '.github/workflows/install-test.yml'
  pull_request:
    branches: [main]
    paths:
      - 'scripts/**'
      - 'homebrew/**'
      - 'rust-mcp/debian/**'
  workflow_dispatch:

jobs:
  test-homebrew-macos:
    name: Test Homebrew (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install from Homebrew tap
        run: |
          brew tap rachmataditiya/odoo-rust-mcp
          brew install rust-mcp

      - name: Verify binary installed
        run: |
          if ! command -v rust-mcp &> /dev/null; then
            echo "FAIL: rust-mcp binary not found"
            exit 1
          fi
          echo "PASS: rust-mcp binary installed"
          
          if ! command -v rust-mcp-service &> /dev/null; then
            echo "FAIL: rust-mcp-service wrapper not found"
            exit 1
          fi
          echo "PASS: rust-mcp-service wrapper installed"
          
          # Test binary runs
          rust-mcp --help
          echo "PASS: rust-mcp --help works"

      - name: Verify share directory config files
        run: |
          SHARE_DIR="$(brew --prefix)/share/odoo-rust-mcp"
          
          # Verify tools.json
          if [ ! -f "$SHARE_DIR/tools.json" ]; then
            echo "FAIL: tools.json not found in $SHARE_DIR"
            exit 1
          fi
          echo "PASS: tools.json exists in share directory"
          
          # Verify prompts.json
          if [ ! -f "$SHARE_DIR/prompts.json" ]; then
            echo "FAIL: prompts.json not found in $SHARE_DIR"
            exit 1
          fi
          echo "PASS: prompts.json exists in share directory"
          
          # Verify server.json
          if [ ! -f "$SHARE_DIR/server.json" ]; then
            echo "FAIL: server.json not found in $SHARE_DIR"
            exit 1
          fi
          echo "PASS: server.json exists in share directory"
          
          # Verify JSON files are valid
          for f in tools.json prompts.json server.json; do
            if ! python3 -c "import json; json.load(open('$SHARE_DIR/$f'))"; then
              echo "FAIL: $f is not valid JSON"
              exit 1
            fi
            echo "PASS: $f is valid JSON"
          done
          
          echo "All share directory config tests passed!"

      - name: Test wrapper creates user config
        run: |
          # Clean any existing config
          rm -rf ~/.config/odoo-rust-mcp
          
          # Run the wrapper (it will fail to connect to Odoo, but should create config first)
          rust-mcp-service --help || true
          
          # Verify config directory was created
          if [ ! -d "$HOME/.config/odoo-rust-mcp" ]; then
            echo "FAIL: Config directory not created"
            exit 1
          fi
          echo "PASS: Config directory exists at ~/.config/odoo-rust-mcp"
          
          # Verify env file was created
          if [ ! -f "$HOME/.config/odoo-rust-mcp/env" ]; then
            echo "FAIL: env file not created"
            exit 1
          fi
          echo "PASS: env file exists"
          
          # Verify env file permissions
          PERMS=$(stat -f "%OLp" "$HOME/.config/odoo-rust-mcp/env")
          if [ "$PERMS" != "600" ]; then
            echo "FAIL: env file permissions are $PERMS, expected 600"
            exit 1
          fi
          echo "PASS: env file has correct permissions (600)"
          
          # Verify env file content
          if ! grep -q "ODOO_URL" "$HOME/.config/odoo-rust-mcp/env"; then
            echo "FAIL: env file missing ODOO_URL"
            exit 1
          fi
          echo "PASS: env file contains ODOO_URL"
          
          if ! grep -q "ODOO_API_KEY" "$HOME/.config/odoo-rust-mcp/env"; then
            echo "FAIL: env file missing ODOO_API_KEY"
            exit 1
          fi
          echo "PASS: env file contains ODOO_API_KEY"
          
          echo "All Homebrew macOS installation tests passed!"

      - name: Cleanup
        run: |
          brew uninstall rust-mcp || true
          brew untap rachmataditiya/odoo-rust-mcp || true

  test-homebrew-linux:
    name: Test Homebrew (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Homebrew on Linux
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.bashrc
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

      - name: Install from Homebrew tap
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew tap rachmataditiya/odoo-rust-mcp
          brew install rust-mcp

      - name: Verify binary installed
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          
          if ! command -v rust-mcp &> /dev/null; then
            echo "FAIL: rust-mcp binary not found"
            exit 1
          fi
          echo "PASS: rust-mcp binary installed"
          
          if ! command -v rust-mcp-service &> /dev/null; then
            echo "FAIL: rust-mcp-service wrapper not found"
            exit 1
          fi
          echo "PASS: rust-mcp-service wrapper installed"
          
          # Test binary runs
          rust-mcp --help
          echo "PASS: rust-mcp --help works"

      - name: Verify share directory config files
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          SHARE_DIR="$(brew --prefix)/share/odoo-rust-mcp"
          
          # Verify all config files
          for f in tools.json prompts.json server.json; do
            if [ ! -f "$SHARE_DIR/$f" ]; then
              echo "FAIL: $f not found in $SHARE_DIR"
              exit 1
            fi
            echo "PASS: $f exists in share directory"
            
            # Verify JSON is valid
            if ! python3 -c "import json; json.load(open('$SHARE_DIR/$f'))"; then
              echo "FAIL: $f is not valid JSON"
              exit 1
            fi
            echo "PASS: $f is valid JSON"
          done
          
          echo "All share directory config tests passed!"

      - name: Test wrapper creates user config
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          
          # Clean any existing config
          rm -rf ~/.config/odoo-rust-mcp
          
          # Run the wrapper
          rust-mcp-service --help || true
          
          # Verify config directory was created
          if [ ! -d "$HOME/.config/odoo-rust-mcp" ]; then
            echo "FAIL: Config directory not created"
            exit 1
          fi
          echo "PASS: Config directory exists"
          
          # Verify env file was created
          if [ ! -f "$HOME/.config/odoo-rust-mcp/env" ]; then
            echo "FAIL: env file not created"
            exit 1
          fi
          echo "PASS: env file exists"
          
          # Verify env file permissions
          PERMS=$(stat -c "%a" "$HOME/.config/odoo-rust-mcp/env")
          if [ "$PERMS" != "600" ]; then
            echo "FAIL: env file permissions are $PERMS, expected 600"
            exit 1
          fi
          echo "PASS: env file has correct permissions (600)"
          
          # Verify env file content
          if ! grep -q "ODOO_URL" "$HOME/.config/odoo-rust-mcp/env"; then
            echo "FAIL: env file missing ODOO_URL"
            exit 1
          fi
          echo "PASS: env file contains expected content"
          
          echo "All Homebrew Linux installation tests passed!"

      - name: Cleanup
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew uninstall rust-mcp || true
          brew untap rachmataditiya/odoo-rust-mcp || true

  test-apt-linux:
    name: Test APT Package (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Add APT repository and install
        run: |
          # Add GPG key (pubkey.gpg is already in binary format, no need to dearmor)
          curl -fsSL https://rachmataditiya.github.io/odoo-rust-mcp/pubkey.gpg | sudo tee /usr/share/keyrings/rust-mcp.gpg > /dev/null
          
          # Add repository
          echo "deb [signed-by=/usr/share/keyrings/rust-mcp.gpg] https://rachmataditiya.github.io/odoo-rust-mcp stable main" | sudo tee /etc/apt/sources.list.d/rust-mcp.list
          
          # Update and install
          sudo apt-get update
          sudo apt-get install -y rust-mcp

      - name: Verify binary installed
        run: |
          if [ ! -f "/usr/bin/rust-mcp" ]; then
            echo "FAIL: rust-mcp binary not found at /usr/bin/rust-mcp"
            exit 1
          fi
          echo "PASS: rust-mcp binary installed"
          
          if [ ! -f "/usr/bin/rust-mcp-service" ]; then
            echo "FAIL: rust-mcp-service wrapper not found"
            exit 1
          fi
          echo "PASS: rust-mcp-service wrapper installed"
          
          # Test binary runs
          rust-mcp --help
          echo "PASS: rust-mcp --help works"

      - name: Verify share directory config files
        run: |
          SHARE_DIR="/usr/share/rust-mcp"
          
          # Verify all config files
          for f in tools.json prompts.json server.json; do
            if [ ! -f "$SHARE_DIR/$f" ]; then
              echo "FAIL: $f not found in $SHARE_DIR"
              exit 1
            fi
            echo "PASS: $f exists in share directory"
            
            # Verify JSON is valid
            if ! python3 -c "import json; json.load(open('$SHARE_DIR/$f'))"; then
              echo "FAIL: $f is not valid JSON"
              exit 1
            fi
            echo "PASS: $f is valid JSON"
          done
          
          echo "All share directory config tests passed!"

      - name: Verify user config created by postinst
        run: |
          # postinst should have created config for the installing user
          # In CI, SUDO_USER may not be set properly, so we check if the mechanism works
          
          # Test wrapper creates config if not exists
          rm -rf ~/.config/rust-mcp
          
          # Run wrapper (will create config)
          rust-mcp-service --help || true
          
          # Verify config directory was created
          if [ ! -d "$HOME/.config/rust-mcp" ]; then
            echo "FAIL: Config directory not created"
            exit 1
          fi
          echo "PASS: Config directory exists at ~/.config/rust-mcp"
          
          # Verify env file was created
          if [ ! -f "$HOME/.config/rust-mcp/env" ]; then
            echo "FAIL: env file not created"
            exit 1
          fi
          echo "PASS: env file exists"
          
          # Verify env file permissions
          PERMS=$(stat -c "%a" "$HOME/.config/rust-mcp/env")
          if [ "$PERMS" != "600" ]; then
            echo "FAIL: env file permissions are $PERMS, expected 600"
            exit 1
          fi
          echo "PASS: env file has correct permissions (600)"
          
          # Verify env file content
          for var in ODOO_URL ODOO_DB ODOO_API_KEY; do
            if ! grep -q "$var" "$HOME/.config/rust-mcp/env"; then
              echo "FAIL: env file missing $var"
              exit 1
            fi
            echo "PASS: env file contains $var"
          done
          
          echo "All APT installation tests passed!"

      - name: Cleanup
        run: |
          sudo apt-get remove -y rust-mcp || true

  test-install-script-linux:
    name: Test install.sh (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Download release binary
        run: |
          # Download the latest release
          mkdir -p test-release
          cd test-release
          
          # Get latest release tarball
          curl -sL "https://github.com/rachmataditiya/odoo-rust-mcp/releases/latest/download/rust-mcp-x86_64-unknown-linux-gnu.tar.gz" | tar xz
          
          # Copy install script
          cp ../scripts/install.sh .
          chmod +x install.sh
          
          ls -la

      - name: Test install.sh
        run: |
          cd test-release
          
          # Test install (to a custom prefix to avoid sudo)
          PREFIX="$HOME/.local" ./install.sh
          
          # Verify binary installed
          if [ ! -f "$HOME/.local/bin/rust-mcp" ]; then
            echo "FAIL: Binary not installed"
            exit 1
          fi
          echo "PASS: Binary installed to ~/.local/bin/rust-mcp"
          
          # Verify config files installed
          CONFIG_DIR="$HOME/.local/share/odoo-rust-mcp"
          if [ ! -d "$CONFIG_DIR" ]; then
            echo "FAIL: Config directory not installed"
            exit 1
          fi
          echo "PASS: Config directory installed"
          
          # Verify individual config files
          for f in tools.json prompts.json server.json; do
            if [ ! -f "$CONFIG_DIR/$f" ]; then
              echo "FAIL: $f not installed"
              exit 1
            fi
            echo "PASS: $f installed"
            
            # Verify JSON is valid
            if ! python3 -c "import json; json.load(open('$CONFIG_DIR/$f'))"; then
              echo "FAIL: $f is not valid JSON"
              exit 1
            fi
            echo "PASS: $f is valid JSON"
          done
          
          # Verify .env.example installed
          if [ ! -f "$CONFIG_DIR/.env.example" ]; then
            echo "FAIL: .env.example not installed"
            exit 1
          fi
          echo "PASS: .env.example installed"
          
          # Test binary runs
          $HOME/.local/bin/rust-mcp --help
          echo "PASS: rust-mcp --help works"

      - name: Test uninstall
        run: |
          cd test-release
          PREFIX="$HOME/.local" ./install.sh uninstall
          
          # Verify binary removed
          if [ -f "$HOME/.local/bin/rust-mcp" ]; then
            echo "FAIL: Binary not removed"
            exit 1
          fi
          echo "PASS: Binary removed"
          
          echo "All install.sh tests passed!"

  test-install-script-windows:
    name: Test install.ps1 (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6

      - name: Download release binary
        shell: pwsh
        run: |
          # Create test directory
          New-Item -ItemType Directory -Force -Path test-release
          
          # Download latest release
          $url = "https://github.com/rachmataditiya/odoo-rust-mcp/releases/latest/download/rust-mcp-x86_64-pc-windows-msvc.zip"
          Invoke-WebRequest -Uri $url -OutFile test-release/release.zip
          
          # Extract
          Expand-Archive -Path test-release/release.zip -DestinationPath test-release -Force
          
          # Copy install script
          Copy-Item scripts/install.ps1 -Destination test-release/
          
          Get-ChildItem test-release

      - name: Test install.ps1 syntax
        shell: pwsh
        run: |
          # Test that the script has valid PowerShell syntax
          $script = Get-Content -Path scripts/install.ps1 -Raw
          $errors = @()
          [System.Management.Automation.Language.Parser]::ParseInput($script, [ref]$null, [ref]$errors)
          if ($errors.Count -gt 0) {
            Write-Error "Script has syntax errors:"
            $errors | ForEach-Object { Write-Error $_.Message }
            exit 1
          }
          Write-Host "PASS: install.ps1 has valid syntax"

      - name: Verify release files
        shell: pwsh
        run: |
          # Verify binary exists
          if (Test-Path test-release/rust-mcp.exe) {
            Write-Host "PASS: Binary exists in test-release"
          } else {
            Write-Error "FAIL: Binary not found"
            exit 1
          }
          
          # Verify config files exist
          $configFiles = @("tools.json", "prompts.json", "server.json")
          foreach ($file in $configFiles) {
            if (Test-Path "test-release/config/$file") {
              Write-Host "PASS: $file exists in config"
            } else {
              Write-Error "FAIL: $file not found in config"
              exit 1
            }
            
            # Verify JSON is valid
            try {
              $content = Get-Content "test-release/config/$file" -Raw
              $null = ConvertFrom-Json $content
              Write-Host "PASS: $file is valid JSON"
            } catch {
              Write-Error "FAIL: $file is not valid JSON: $_"
              exit 1
            }
          }
          
          # Test binary runs
          & test-release/rust-mcp.exe --help
          Write-Host "PASS: rust-mcp.exe --help works"

      - name: Test user config directory creation
        shell: pwsh
        run: |
          # Simulate what wrapper would do for user config
          $ConfigDir = Join-Path $env:USERPROFILE ".config/odoo-rust-mcp"
          
          # Clean any existing config
          if (Test-Path $ConfigDir) {
            Remove-Item -Recurse -Force $ConfigDir
          }
          
          # Create config directory
          New-Item -ItemType Directory -Force -Path $ConfigDir | Out-Null
          
          # Create default env file
          $envContent = "# Odoo Rust MCP Server Configuration`nODOO_URL=http://localhost:8069`nODOO_DB=mydb`nODOO_API_KEY=YOUR_API_KEY"
          Set-Content -Path (Join-Path $ConfigDir "env") -Value $envContent
          
          # Verify config directory was created
          if (Test-Path $ConfigDir) {
            Write-Host "PASS: Config directory created at $ConfigDir"
          } else {
            Write-Error "FAIL: Config directory not created"
            exit 1
          }
          
          # Verify env file was created
          $envFile = Join-Path $ConfigDir "env"
          if (Test-Path $envFile) {
            Write-Host "PASS: env file created"
          } else {
            Write-Error "FAIL: env file not created"
            exit 1
          }
          
          # Verify env file content
          $content = Get-Content $envFile -Raw
          if ($content -match "ODOO_URL") {
            Write-Host "PASS: env file contains ODOO_URL"
          } else {
            Write-Error "FAIL: env file missing ODOO_URL"
            exit 1
          }
          
          Write-Host "All Windows installation tests passed!"
